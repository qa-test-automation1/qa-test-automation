name: Auto close parent issue when all sub-issues are Done

on:
  issues:
    types: [labeled, unlabeled, closed, reopened]

jobs:
  auto-done:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Sync Parent Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.payload.issue.number;

            // 1. Récupérer le parent de l'issue actuelle via GraphQL
            const getParentQuery = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    parent {
                      number
                      subIssues(first: 50) {
                        nodes {
                          number
                          labels(first: 10) {
                            nodes { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const data = await github.graphql(getParentQuery, { owner, repo, number: issueNumber });
            const parent = data.repository.issue.parent;

            // Si l'issue n'a pas de parent, on s'arrête
            if (!parent) {
              console.log("Cette issue n'est pas une sub-issue.");
              return;
            }

            const parentNumber = parent.number;
            const subIssues = parent.subIssues.nodes;

            console.log(`Analyse des sub-issues pour le parent #${parentNumber}...`);

            // 2. Vérifier si TOUTES les sub-issues sont "Done"
            const allSubIssuesDone = subIssues.every(sub => 
              sub.labels.nodes.some(l => l.name === 'Done')
            );

            if (allSubIssuesDone) {
              console.log(`Toutes les sub-issues de #${parentNumber} sont prêtes !`);

              // 3. Ajouter le label 'Done' au parent
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: parentNumber,
                labels: ['Done']
              });

              // 4. Commentaire optionnel sur le parent
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: parentNumber,
                body: "✅ Toutes les sub-issues sont terminées. Passage automatique de l'issue parente à **Done**."
              });
            } else {
              console.log("Certaines sub-issues ne sont pas encore 'Done'.");
            }
