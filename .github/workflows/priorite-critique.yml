name: Alerte Priorit√© Critique v2

on:
  issues:
    types: [opened, labeled]

jobs:
  gestion-priorite:
    if: github.event.label.name == 'Critical' || contains(github.event.issue.labels.*.name, 'Critical')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read
      projects: write

    steps:
      - name: 1Ô∏è‚É£ Assignation automatique selon le label
        uses: actions/github-script@v7
        with:
          script: |
            const labelAssignees = {
              "Critical": "ghazi-qa",
              "High": "tester1",
              "Medium": "tester2"
            };

            const labels = context.payload.issue.labels.map(l => l.name);
            let assignee = null;

            for (const label of labels) {
              if (labelAssignees[label]) {
                assignee = labelAssignees[label];
                break;
              }
            }

            if (assignee) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [assignee]
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `üö® **Issue ${labels.join(", ")}** assign√©e automatiquement √† **@${assignee}**`
              });
            }

      - name: 2Ô∏è‚É£ D√©placement vers Todo (Project v2)
        uses: leonsteinhaeuser/project-beta-automations@v2.2.1
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          organization: qa-test-automation-org
          project_id: 1          # üî¥ REMPLACE PAR TON ID EXACT
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: "Todo"
