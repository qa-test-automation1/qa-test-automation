name: Alerte Priorit√© Critique v2

on:
  issues:
    types: [opened, labeled]

jobs:
  gestion-priorite:
    # On s'assure que le job ne tourne que pour le label 'Critical'
    if: github.event.label.name == 'Critical' || contains(github.event.issue.labels.*.name, 'Critical')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      repository-projects: write

    steps:
      - name: Assignation et Mise √† jour Projet
        uses: actions/github-script@v7
        with:
          # --- Utilisation de ton nom de secret exact ---
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.issue.number;
            const issueNodeId = context.payload.issue.node_id;

            // 1. Assignation de l'owner du repo
            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number: issueNumber,
              assignees: [owner]
            });

            // 2. Ajout du commentaire
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: "üö® **Alerte Critique** : Issue assign√©e automatiquement et d√©plac√©e dans le statut 'In Progress'."
            });

            // 3. Logique GraphQL pour le Projet V2
            const projectNumber = 1;
            const orgName = "qa-test-automation-org";
            
            const query = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }`;

            const projectData = await github.graphql(query, {
              org: orgName,
              number: projectNumber
            });

            const project = projectData.organization.projectV2;
            if (!project) {
                throw new Error("Projet introuvable. V√©rifiez que le PAT a les droits sur l'organisation.");
            }

            const statusField = project.fields.nodes.find(f => f.name === "Status");
            const inProgressOption = statusField.options.find(o => o.name === "In Progress");

            // Ajout de l'issue au projet
            const addItemMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item { id }
                }
              }`;

            const itemData = await github.graphql(addItemMutation, {
              projectId: project.id,
              contentId: issueNodeId
            });

            // Mise √† jour du statut vers "In Progress"
            const updateStatusMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) { clientMutationId }
              }`;

            await github.graphql(updateStatusMutation, {
              projectId: project.id,
              itemId: itemData.addProjectV2ItemById.item.id,
              fieldId: statusField.id,
              optionId: inProgressOption.id
            });
            
            console.log("Succ√®s : Issue trait√©e et d√©plac√©e.");
