name: Validation QA

on:
  project_item:
    types: [edited]

jobs:
  assign-qa:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      repository-projects: read
      contents: read

    steps:
      - name: Vérifier le statut et assigner QA
        uses: actions/github-script@v7
        with:
          script: |
            const projectId = 1;
            const qaUser = "Ghazi-Kriaa";

            const itemId = context.payload.project_item.id;

            // 1️⃣ Récupérer les champs du Project item
            const query = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2SingleSelectField {
                              name
                            }
                          }
                        }
                      }
                    }
                    content {
                      ... on Issue {
                        number
                        repository {
                          name
                          owner {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, { itemId });

            // 2️⃣ Chercher le champ Status
            const statusField = result.node.fieldValues.nodes.find(
              f => f.field?.name === "Status"
            );

            if (!statusField || statusField.name !== "Done") {
              console.log("⏭️ Status non Done → arrêt");
              return;
            }

            // 3️⃣ Assigner le QA
            const issue = result.node.content;

            await github.rest.issues.addAssignees({
              owner: issue.repository.owner.login,
              repo: issue.repository.name,
              issue_number: issue.number,
              assignees: [qaUser]
            });

            console.log("✅ Issue assignée au QA");
