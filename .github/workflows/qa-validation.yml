name: Validation QA

on:
  project_item:
    types: [edited]

jobs:
  validation-qa:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      repository-projects: write
      contents: read

    steps:
      - name: Debug event (IMPORTANT la 1ère fois)
        run: |
          echo '${{ toJson(github.event) }}'

      - name: Assigner le responsable QA si Status = Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION }}
          script: |
            const item = context.payload.project_item;
            const changes = context.payload.changes;

            if (!changes || !changes.field_value) {
              console.log("Pas de changement de champ détecté");
              return;
            }

            const fieldName = changes.field_value.field_name;
            const newValue = changes.field_value.value;

            console.log(`Champ modifié: ${fieldName}`);
            console.log(`Nouvelle valeur: ${newValue}`);

            // ✅ Condition clé
            if (fieldName === "Status" && newValue === "Done") {
              const issueNodeId = item.content_node_id;

              if (!issueNodeId) {
                console.log("Ce project item n'est pas une issue");
                return;
              }

              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.project_item.content.number,
                assignees: ["Ghazi-Kriaa"]
              });

              console.log("Responsable QA assigné !");
            } else {
              console.log("Status ≠ Done → aucune action");
            }
