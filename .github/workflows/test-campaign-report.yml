name: Test Campaign Report

on:
  workflow_dispatch:
  milestone:
    types: [closed]

jobs:
  generate-report:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write

    steps:
      - name: Generate Campaign Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // RÃ©cupÃ©rer toutes les issues fermÃ©es
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                state: "closed",
                per_page: 100
              }
            );

            let passed = 0;
            let failed = 0;

            issues.forEach(issue => {
              const labels = issue.labels.map(l => l.name);
              if (labels.includes("test-pass")) passed++;
              if (labels.includes("test-fail")) failed++;
            });

            const total = passed + failed;
            const successRate = total > 0 
              ? ((passed / total) * 100).toFixed(2) 
              : 0;

            const report = `
            # ğŸ“Š Rapport de Campagne de Test

            - âœ… Tests Passed : ${passed}
            - âŒ Tests Failed : ${failed}
            - ğŸ“¦ Total exÃ©cutÃ©s : ${total}
            - ğŸ¯ Taux de rÃ©ussite : ${successRate} %

            ---

            _GÃ©nÃ©rÃ© automatiquement par le systÃ¨me QA._
            `;

            // CrÃ©er une issue rapport
            await github.rest.issues.create({
              owner,
              repo,
              title: "ğŸ“Š Rapport de Campagne de Test",
              body: report
            });
