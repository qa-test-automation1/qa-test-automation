name: Test Campaign Report Advanced

on:
  workflow_dispatch:
  milestone:
    types: [closed]

jobs:
  generate-report:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Campaign Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // VÃ©rifier si workflow dÃ©clenchÃ© par milestone fermÃ©
            const milestone = context.payload.milestone;
            let milestoneNumber = null;
            let milestoneTitle = null;

            if (milestone) {
              milestoneNumber = milestone.number;
              milestoneTitle = milestone.title;
              console.log(`Workflow dÃ©clenchÃ© par milestone: ${milestoneTitle} (#${milestoneNumber})`);
            } else {
              console.log("Workflow dÃ©clenchÃ© manuellement (workflow_dispatch)");
            }

            // RÃ©cupÃ©rer toutes les issues fermÃ©es
            let issues = [];
            if (milestoneNumber) {
              // Filtrer par milestone number
              issues = await github.paginate(
                github.rest.issues.listForRepo,
                {
                  owner,
                  repo,
                  state: "closed",
                  milestone: milestoneNumber,
                  per_page: 100
                }
              );
            } else {
              // fallback pour workflow_dispatch manuel
              issues = await github.paginate(
                github.rest.issues.listForRepo,
                {
                  owner,
                  repo,
                  state: "closed",
                  per_page: 100
                }
              );
            }

            console.log(`Nombre d'issues dÃ©tectÃ©es: ${issues.length}`);

            // Compter Passed / Failed
            let passed = 0;
            let failed = 0;
            let passedIssues = [];
            let failedIssues = [];

            issues.forEach(issue => {
              const labels = issue.labels.map(l => l.name.toLowerCase());

              if (labels.includes("test-pass")) {
                passed++;
                passedIssues.push(`#${issue.number} ${issue.title}`);
              }
              if (labels.includes("test-fail")) {
                failed++;
                failedIssues.push(`#${issue.number} ${issue.title}`);
              }
            });

            const total = passed + failed;
            const successRate = total > 0 ? ((passed / total) * 100).toFixed(2) : 0;
            const decision = successRate >= 80 ? "âœ… PrÃªt pour production" : "âŒ Non recommandÃ© pour production";

            const report = `
            # ğŸ“Š Rapport de Campagne de Test ${milestoneTitle ? `- ${milestoneTitle}` : ''}

            - âœ… Tests Passed : ${passed}
            ${passedIssues.map(i => `  - ${i}`).join("\n")}

            - âŒ Tests Failed : ${failed}
            ${failedIssues.map(i => `  - ${i}`).join("\n")}

            - ğŸ“¦ Total exÃ©cutÃ©s : ${total}
            - ğŸ¯ Taux de rÃ©ussite : ${successRate} %
            - ğŸ“ Recommandation : ${decision}

            ---

            _GÃ©nÃ©rÃ© automatiquement par le systÃ¨me QA._
            `;

            console.log(report);

            // CrÃ©er une issue rapport
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸ“Š Rapport de Campagne de Test ${milestoneTitle ? `- ${milestoneTitle}` : ''}`,
              body: report,
              labels: ["health-check"]
            });
