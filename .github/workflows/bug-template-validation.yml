name: Bug Report Template Validation

on:
  issues:
    types: [opened, edited]

jobs:
  validate-bug-report:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Validate Issue Fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const issueNumber = issue.number;

            const requiredFields = [
              "Test Case associé",
              "Description du bug",
              "Étapes pour reproduire le bug",
              "Comportement attendu",
              "Sévérité"
            ];

            let missingFields = [];

            for (const field of requiredFields) {
              if (!body.includes(field)) {
                missingFields.push(field);
              }
            }

            const hasNeedsInfo = issue.labels.some(l => l.name === "Needs Info");

            if (missingFields.length > 0) {

              if (!hasNeedsInfo) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["Needs Info"]
                });
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `⚠️ Certaines informations obligatoires sont manquantes :

                ${missingFields.join("\n")}

                Merci de compléter le rapport avant traitement.`
              });

            } else {

              if (hasNeedsInfo) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: "Needs Info"
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: "✅ Merci, le bug report est complet."
                });
              }
            }
