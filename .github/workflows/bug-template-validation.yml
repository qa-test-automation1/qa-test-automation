name: Bug Report Template Validation

on:
  issues:
    types: [opened, edited]

jobs:
  validate-bug-report:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Validate Issue Template
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body || "";
            const issueNumber = issue.number;

            const requiredSections = [
              "### Étapes de reproduction",
              "### Comportement attendu",
              "### Logs"
            ];

            let missingSections = [];

            for (const section of requiredSections) {
              const regex = new RegExp(`${section}[\\s\\S]*?(?=###|$)`, "i");
              const match = issueBody.match(regex);

              if (!match || match[0].trim() === section) {
                missingSections.push(section);
              }
            }

            const hasNeedsInfoLabel = issue.labels.some(
              label => label.name === "Needs Info"
            );

            if (missingSections.length > 0) {

              if (!hasNeedsInfoLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["Needs Info"]
                });
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `⚠️ Merci de compléter les sections suivantes :

${missingSections.join("\n")}

Un bug complet permet une prise en charge rapide par l'équipe QA.`
              });

            } else {

              if (hasNeedsInfoLabel) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: "Needs Info"
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: "✅ Merci, le rapport est maintenant complet."
                });
              }
            }
