name: Block Done if sub-issues not completed

on:
  issues:
    types: [labeled]

jobs:
  block-done:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'Done'
    permissions:
      issues: write
      repository-projects: read # Requis pour les relations

    steps:
      - name: Check Sub-issues Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Requête GraphQL pour récupérer les sub-issues réelles
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    subIssues(first: 50) {
                      nodes {
                        number
                        state
                        labels(first: 20) {
                          nodes {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = { owner, repo, number: issueNumber };
            const result = await github.graphql(query, variables);
            const subIssues = result.repository.issue.subIssues.nodes;

            if (subIssues.length === 0) return;

            // Vérifier si toutes les sub-issues ont le label 'Done'
            const incompleteSubIssues = subIssues.filter(sub => {
              const isDone = sub.labels.nodes.some(l => l.name === 'Done');
              return !isDone;
            });

            if (incompleteSubIssues.length > 0) {
              // 1. Retirer le label 'Done' de l'issue parente
              await github.rest.issues.removeLabel({
                owner, repo,
                issue_number: issueNumber,
                name: 'Done'
              });

              // 2. Ajouter un commentaire d'explication
              const list = incompleteSubIssues.map(s => `#${s.number}`).join(', ');
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: issueNumber,
                body: `⚠️ **Action bloquée** : Cette issue possède des sous-tâches non terminées (${list}). Veuillez les passer en **Done** avant de clôturer le parent.`
              });
            }
